{% extends "layouts/base.html" %}

{% block title %}Chat dengan Putri - Lelana.id{% endblock %}

{% block content %}
    <div class="-mx-4 -my-6 sm:-mx-6 sm:-my-8">
        <div class="flex flex-col h-[85vh] bg-gray-50 dark:bg-gray-900 overflow-hidden">
            <!-- Header Chat -->
            <div class="flex-shrink-0 p-3 sm:p-4 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0">
                        <span class="inline-flex items-center justify-center h-10 w-10 rounded-full bg-primary-100 dark:bg-primary-900/30">
                            <svg class="h-6 w-6 text-primary-600 dark:text-primary-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 9.75a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375m-13.5 3.01c0 1.6 1.123 2.994 2.707 3.227 1.087.16 2.185.283 3.293.369V21l4.184-4.183a1.14 1.14 0 01.778-.332 48.294 48.294 0 005.83-.498c1.585-.233 2.708-1.626 2.708-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" />
                            </svg>
                        </span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-base sm:text-lg font-semibold text-gray-900 dark:text-white">Putri - Asisten Wisata</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Online</p>
                    </div>
                </div>
            </div>

            <!-- Area Pesan -->
            <div class="flex-1 p-4 sm:p-6 space-y-6 overflow-y-auto" id="chat-history">
                <!-- Pesan Awal dari Bot -->
                <div class="flex items-start gap-3" id="initial-bot-message">
                    <div class="flex-shrink-0">
                        <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-primary-100 dark:bg-primary-900/30">
                            <svg class="h-5 w-5 text-primary-600 dark:text-primary-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 9.75a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375m-13.5 3.01c0 1.6 1.123 2.994 2.707 3.227 1.087.16 2.185.283 3.293.369V21l4.184-4.183a1.14 1.14 0 01.778-.332 48.294 48.294 0 005.83-.498c1.585-.233 2.708-1.626 2.708-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" />
                            </svg>
                        </span>
                    </div>
                    <div class="flex-1">
                        <div class="inline-block bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 p-3 rounded-lg rounded-tl-none shadow">
                            <p>Hai! Aku Putri, asisten wisatamu dari Lelana.id. Ada yang bisa kubantu terkait rencana perjalananmu?</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Input -->
            <div class="flex-shrink-0 p-2 sm:p-4 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
                <div class="relative">
                    <input type="text" id="user-input" placeholder="Ketik pertanyaanmu di sini..." autocomplete="off" class="block w-full py-3 pl-4 pr-16 text-sm sm:text-base text-gray-900 dark:text-white bg-gray-100 dark:bg-gray-700 rounded-full border-transparent focus:border-primary-500 focus:ring-2 focus:ring-primary-500 transition duration-200">
                    <button id="send-btn" class="absolute inset-y-0 right-0 flex items-center justify-center w-14 h-full text-primary-600 hover:text-primary-700 dark:text-primary-400 dark:hover:text-primary-300 transition duration-200">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatHistory = document.getElementById('chat-history');
            const userInput = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const csrfToken = '{{ csrf_token() }}';

            chatHistory.scrollTop = chatHistory.scrollHeight;

            function formatText(text) {
                let formatted = text
                    .replace(/</g, "<")
                    .replace(/>/g, ">")
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

                const lines = formatted.split('\n');
                let inList = false;
                let result = '';
                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i];
                    const isListItem = line.trim().startsWith('*') || line.trim().startsWith('-');

                    if (isListItem && !inList) {
                        inList = true;
                        result += '<ul>';
                    }
                    if (!isListItem && inList) {
                        inList = false;
                        result += '</ul>';
                    }

                    if (isListItem) {
                        result += '<li class="ml-5 list-disc">' + line.trim().substring(1).trim() + '</li>';
                    } else {
                        result += line + (i < lines.length - 1 ? '<br>' : '');
                    }
                }
                if (inList) {
                    result += '</ul>';
                }
                return result;
            }

            function addMessage(sender, text) {
                const messageWrapper = document.createElement('div');
                const formattedText = formatText(text);

                if (sender === 'user') {
                    messageWrapper.classList.add('flex', 'justify-end', 'items-start', 'gap-3');
                    messageWrapper.innerHTML = `
                        <div class="flex-1 text-right">
                            <div class="inline-block bg-primary-600 text-white p-3 rounded-lg rounded-br-none shadow">
                                <p>${formattedText}</p>
                            </div>
                        </div>
                        <div class="flex-shrink-0">
                            <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-gray-600 text-white">
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-5.5-2.5a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0zM10 12a5.99 5.99 0 00-4.793 2.39A6.483 6.483 0 0010 16.5a6.483 6.483 0 004.793-2.11A5.99 5.99 0 0010 12z" clip-rule="evenodd" />
                                </svg>
                            </span>
                        </div>
                    `;
                } else {
                    messageWrapper.classList.add('flex', 'items-start', 'gap-3');
                    messageWrapper.innerHTML = `
                        <div class="flex-shrink-0">
                            <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-primary-100 dark:bg-primary-900/30">
                                <svg class="h-5 w-5 text-primary-600 dark:text-primary-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                   <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 9.75a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375m-13.5 3.01c0 1.6 1.123 2.994 2.707 3.227 1.087.16 2.185.283 3.293.369V21l4.184-4.183a1.14 1.14 0 01.778-.332 48.294 48.294 0 005.83-.498c1.585-.233 2.708-1.626 2.708-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" />
                                </svg>
                            </span>
                        </div>
                        <div class="flex-1">
                            <div class="inline-block bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 p-3 rounded-lg rounded-tl-none shadow">
                                <div class="message-content">${formattedText}</div>
                            </div>
                        </div>
                    `;
                }

                chatHistory.appendChild(messageWrapper);
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }

            async function askBot() {
                const query = userInput.value.trim();
                if (query === "") return;

                addMessage('user', query);
                userInput.value = "";
                sendBtn.disabled = true;

                const thinkingMessage = document.createElement('div');
                thinkingMessage.classList.add('flex', 'items-start', 'gap-3', 'thinking');
                thinkingMessage.innerHTML = `
                    <div class="flex-shrink-0">
                        <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-primary-100 dark:bg-primary-900/30">
                            <svg class="h-5 w-5 text-primary-600 dark:text-primary-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                               <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 9.75a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375m-13.5 3.01c0 1.6 1.123 2.994 2.707 3.227 1.087.16 2.185.283 3.293.369V21l4.184-4.183a1.14 1.14 0 01.778-.332 48.294 48.294 0 005.83-.498c1.585-.233 2.708-1.626 2.708-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" />
                            </svg>
                        </span>
                    </div>
                    <div class="flex-1">
                        <div class="inline-block bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 p-3 rounded-lg rounded-tl-none shadow">
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div>
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div>
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div>
                            </div>
                        </div>
                    </div>
                `;
                chatHistory.appendChild(thinkingMessage);
                chatHistory.scrollTop = chatHistory.scrollHeight;

                try {
                    const response = await fetch('{{ url_for("chatbot.ask_putri") }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ query: query }),
                    });

                    chatHistory.removeChild(thinkingMessage);

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ response: "Maaf, terjadi error tidak dikenal saat menghubungi Putri." }));
                        addMessage('bot', errorData.response || "Maaf, terjadi error tidak dikenal.");
                        return;
                    }

                    const data = await response.json();
                    addMessage('bot', data.response);

                } catch (error) {
                    chatHistory.removeChild(thinkingMessage);
                    addMessage('bot', "Koneksi ke Putri gagal. Coba periksa jaringan internetmu.");
                    console.error("Fetch error:", error);
                } finally {
                    sendBtn.disabled = false;
                    userInput.focus();
                }
            }

            sendBtn.addEventListener('click', askBot);
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    askBot();
                }
            });
        });
    </script>
{% endblock %}